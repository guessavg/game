<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GuessÂ 2â€¯/â€¯3Â GameÂ â€”Â BaseÂ Network</title>

  <!-- Ethers v6 UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>

  <style>
    /* Simple responsive layout */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      background: #f9f9f9;
    }

    h1 {
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.5rem;
    }

    button {
      padding: 10px 18px;
      margin-top: 1rem;
      margin-right: 10px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #009688;
      color: white;
    }

    button:hover { background: #00796B; }

    #connectBtn       { background: #222; }
    #connectBtn:hover { background: #444; }

    .player { margin-bottom: 8px; }

    #players {
      padding: 0.5rem 0;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      margin-top: 0.5rem;
    }

    #status { margin-top: 1rem; font-weight: bold; }

    .info-block {
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    input[type="number"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 120px;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h1>ğŸ® GuessÂ Twoâ€‘ThirdsÂ GameÂ (onÂ Base)</h1>

  <!-- Wallet & network -->
  <div class="info-block">
    <button id="connectBtn" onclick="connectWallet()">ğŸ”ŒÂ ConnectÂ Wallet</button>
    <button onclick="addBaseNetwork()">â•Â AddÂ BaseÂ Network</button>
    <div id="walletAddress">WalletÂ notÂ connected</div>
  </div>

  <!-- Live round data -->
  <div class="info-block">
    <strong>CurrentÂ Round:</strong>Â <span id="gameId">-</span><br />
    <strong>Players:</strong>
    <div id="players">Loadingâ€¦</div>
  </div>

  <!-- Last result & contract balance -->
  <div class="info-block">
    <strong>ContractÂ Balance:</strong>Â <span id="contractBalance">-</span>Â ETH<br />
    <strong>LastÂ Winner:</strong>Â <span id="lastWinner">-</span><br />
    <strong>LastÂ Reward:</strong>Â <span id="lastReward">-</span>Â ETH<br />
  </div>

  <!-- Join the game -->
  <div class="info-block">
    <label for="amount">Enter amountÂ (ETH):Â </label>
    <input type="number" id="amount" min="0.001" step="0.001" value="0.01" />
    <button id="joinBtn" onclick="joinGame()" disabled>ğŸ•¹ï¸Â JoinÂ Game</button>
  </div>

  <div id="status"></div>

  <script>
    /* ------------------------------------------------------------------ */
    /*             1.  Contract / network configuration                   */
    /* ------------------------------------------------------------------ */

    // Deployed contract on Base mainnet
    const CONTRACT_ADDRESS = "0x4BbeE9F876ff56832E724DC9a7bD06538C8868D2";

    // Public Base RPC (readâ€‘only fallback)
    const RPC_URL = "https://base-rpc.publicnode.com";

    // Base chain ID in hex (8453 decimals)
    const CHAIN_ID_HEX = "0x2105";

    /* Contract ABI (minimal) */
    const ABI = [
      "function gameId() view returns (uint256)",
      "function players(uint256) view returns (address addr, uint256 amount)",
      "function play() payable",
      "function hasPlayed(address) view returns (bool)",
      "event PlayerJoined(address indexed player, uint256 amount)",
      "event GameEnded(uint256 indexed gameId, address winner, uint256 reward, uint256 guessTarget)"
    ];

    let provider, signer, contract;

    /* ------------------------------------------------------------------ */
    /*                       2.  Wallet helpers                           */
    /* ------------------------------------------------------------------ */

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask (or another provider) not detected.");
        return;
      }

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        // Request account access
        await provider.send("eth_requestAccounts", []);
        signer   = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const addr = await signer.getAddress();
        document.getElementById("walletAddress").textContent = "Connected:Â " + addr;
        document.getElementById("status").textContent        = "âœ…Â WalletÂ connected.";
        document.getElementById("joinBtn").disabled          = false;

        await loadGameInfo();
      } catch (err) {
        console.error(err);
        alert("Connection failed. Check console for details.");
      }
    }

    /* Add or switch to the Base network in MetaMask */
    async function addBaseNetwork() {
      if (!window.ethereum) {
        alert("MetaMask not detected.");
        return;
      }

      try {
        // Try switching first
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: CHAIN_ID_HEX }],
        });
        document.getElementById("status").textContent = "âœ…Â SwitchedÂ toÂ Base.";
      } catch (switchError) {
        // Unknown chain â€“Â offer to add it
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: CHAIN_ID_HEX,
                chainName: "Base",
                rpcUrls: [RPC_URL],
                nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                blockExplorerUrls: ["https://basescan.org"]
              }]
            });
            document.getElementById("status").textContent = "âœ…Â BaseÂ addedÂ andÂ selected.";
          } catch (addError) {
            console.error("Add network failed:", addError);
            alert("âŒÂ FailedÂ toÂ addÂ BaseÂ network.\n\n" + (addError.message || addError));
          }
        } else {
          console.error("Switch network failed:", switchError);
          alert("âŒÂ FailedÂ toÂ switchÂ toÂ Base.\n\n" + (switchError.message || switchError));
        }
      }
    }

    /* ------------------------------------------------------------------ */
    /*                     3.  Load onâ€‘chain data                         */
    /* ------------------------------------------------------------------ */

    async function loadGameInfo() {
      document.getElementById("status").textContent = "ğŸ”„Â LoadingÂ gameÂ infoâ€¦";

      try {
        // Use public RPC if no provider yet
        if (!provider) provider = new ethers.JsonRpcProvider(RPC_URL);
        if (!contract) contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

        /* Current round ID */
        const gameId = await contract.gameId();
        document.getElementById("gameId").textContent = gameId.toString();

        /* List all players (until outâ€‘ofâ€‘range revert) */
        let playersHTML = "";
        for (let i = 0; ; ++i) {
          try {
            const p = await contract.players(i);
            playersHTML += `<div class="player">#${i + 1}:Â ${p.addr}Â â€”Â ${ethers.formatEther(p.amount)}Â ETH</div>`;
          } catch {
            break; // reached the end of the dynamic array
          }
        }
        document.getElementById("players").innerHTML = playersHTML || "No players yet.";

        /* Contract balance */
        const balance = await provider.getBalance(CONTRACT_ADDRESS);
        document.getElementById("contractBalance").textContent = ethers.formatEther(balance);

        /* Last GameEnded event */
        const topic = ethers.id("GameEnded(uint256,address,uint256,uint256)");
        const logs  = await provider.getLogs({
          address: CONTRACT_ADDRESS,
          fromBlock: "earliest",
          toBlock: "latest",
          topics: [topic],
        });

        if (logs.length > 0) {
          const lastLog = logs[logs.length - 1];
          const parsed  = contract.interface.parseLog(lastLog);
          document.getElementById("lastWinner").textContent = parsed.args.winner;
          document.getElementById("lastReward").textContent = ethers.formatEther(parsed.args.reward);
        } else {
          document.getElementById("lastWinner").textContent = "No game ended yet";
          document.getElementById("lastReward").textContent = "-";
        }

        document.getElementById("status").textContent = "âœ…Â GameÂ dataÂ loaded.";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "âŒÂ FailedÂ toÂ loadÂ gameÂ info.";
      }
    }

    /* ------------------------------------------------------------------ */
    /*                        4.  Play the game                            */
    /* ------------------------------------------------------------------ */

    async function joinGame() {
      if (!signer) {
        alert("Please connect your wallet first.");
        return;
      }

      const amount  = document.getElementById("amount").value;
      const joinBtn = document.getElementById("joinBtn");
      joinBtn.disabled = true;
      document.getElementById("status").textContent = "ğŸ“¤Â SendingÂ transactionâ€¦";

      try {
        const tx = await contract.play({ value: ethers.parseEther(amount) });
        await tx.wait();
        document.getElementById("status").textContent = "âœ…Â SuccessfullyÂ joined!";
        await loadGameInfo(); // refresh the UI
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "âŒÂ TransactionÂ failed.";
      }

      joinBtn.disabled = false;
    }

    /* ------------------------------------------------------------------ */
    /*                5.  Autoâ€‘load info on page load                      */
    /* ------------------------------------------------------------------ */

    window.addEventListener("load", async () => {
      await loadGameInfo();

      /* Autoâ€‘connect if MetaMask is already authorised */
      if (window.ethereum) {
        const accounts = await window.ethereum.request({ method: "eth_accounts" });
        if (accounts.length > 0) await connectWallet();
      }
    });
  </script>
</body>
</html>
