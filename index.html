<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Guess 2/3 Game</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
      background: #f9f9f9;
    }

    button {
      padding: 10px 18px;
      margin-top: 1rem;
      margin-right: 10px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #009688;
      color: white;
    }

    button:hover {
      background: #00796B;
    }

    #connectBtn {
      background: #222;
    }

    #connectBtn:hover {
      background: #444;
    }

    .player {
      margin-bottom: 8px;
    }

    #status {
      margin-top: 1rem;
      font-weight: bold;
    }

    .info-block {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <h1>üéÆ Guess Two-Thirds Game</h1>

  <div class="info-block">
    <button id="connectBtn" onclick="connectWallet()">üîå Connect Wallet</button>
    <button onclick="addOiiaNetwork()">‚ûï Add Oiia Network</button>
    <div id="walletAddress">Wallet not connected</div>
  </div>

  <div class="info-block">
    <strong>Current Round:</strong> <span id="gameId">-</span><br />
    <strong>Players:</strong>
    <div id="players">Loading...</div>
  </div>

  <div class="info-block">
    <strong>Contract Balance:</strong> <span id="contractBalance">-</span> OIIA<br />
    <strong>Last Winner:</strong> <span id="lastWinner">-</span><br />
    <strong>Last Reward:</strong> <span id="lastReward">-</span> OIIA<br />
  </div>

  <div>
    <label for="amount">Enter amount (OIIA): </label>
    <input type="number" id="amount" min="0.001" step="0.001" value="0.01" />
    <button id="joinBtn" onclick="joinGame()" disabled>üïπÔ∏è Join Game</button>
  </div>

  <div id="status"></div>

  <script>
    const CONTRACT_ADDRESS = "0x6eb079c9d3005bd596e8a0e5065fa33c80aba8f1";
    const RPC_URL = "https://rpc.oiia.network";
    const CHAIN_ID_HEX = "0x1348BF3";

    const ABI = [
      "function gameId() view returns (uint256)",
      "function players(uint256) view returns (address addr, uint256 amount)",
      "function play() payable",
      "function hasPlayed(address) view returns (bool)",
      "event PlayerJoined(address indexed player, uint256 amount)",
      "event GameEnded(uint256 indexed gameId, address winner, uint256 reward, uint256 guessTarget)"
    ];

    let provider, signer, contract;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask not detected.");
        return;
      }

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const addr = await signer.getAddress();
        document.getElementById("walletAddress").textContent = "Connected: " + addr;
        document.getElementById("status").textContent = "‚úÖ Wallet connected.";
        document.getElementById("joinBtn").disabled = false;

        await loadGameInfo();
      } catch (err) {
        console.error(err);
        alert("Connection failed.");
      }
    }

    async function addOiiaNetwork() {
      if (!window.ethereum) {
        alert("MetaMask not detected.");
        return;
      }

      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [
            {
              chainId: '0x1348bf3', // 20220915 in hex, lowercase is safer
              chainName: 'Oiia Network',
              rpcUrls: ['https://rpc.oiia.network'],
              nativeCurrency: {
                name: 'OIIA',
                symbol: 'OIIA',
                decimals: 18
              },
              blockExplorerUrls: ['https://explorer.oiia.network']
            }
          ]
        });

        document.getElementById("status").textContent = "‚úÖ Oiia Network added.";
      } catch (error) {
        console.error('Failed to add network:', error);
        alert("‚ùå Failed to add Oiia Network.\n\nDetails:\n" + (error.message || error));
      }
    }


    async function loadGameInfo() {
      document.getElementById("status").textContent = "üîÑ Loading game info...";

      try {
        if (!provider) {
          provider = new ethers.JsonRpcProvider(RPC_URL);
        }
        if (!contract) {
          contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
        }

        const gameId = await contract.gameId();
        document.getElementById("gameId").textContent = gameId.toString();

        let playersHTML = "";
        for (let i = 0; ; i++) {
          try {
            const p = await contract.players(i);
            playersHTML += `<div class="player">#${i + 1}: ${p.addr} ‚Äî ${ethers.formatEther(p.amount)} OIIA</div>`;
          } catch {
            break;
          }
        }
        document.getElementById("players").innerHTML = playersHTML || "No players yet.";

        const balance = await provider.getBalance(CONTRACT_ADDRESS);
        document.getElementById("contractBalance").textContent = ethers.formatEther(balance);

        const topic = ethers.id("GameEnded(uint256,address,uint256,uint256)");
        const logs = await provider.getLogs({
          address: CONTRACT_ADDRESS,
          fromBlock: "earliest",
          toBlock: "latest",
          topics: [topic],
        });

        if (logs.length > 0) {
          const lastLog = logs[logs.length - 1];
          const parsed = contract.interface.parseLog(lastLog);
          document.getElementById("lastWinner").textContent = parsed.args.winner;
          document.getElementById("lastReward").textContent = ethers.formatEther(parsed.args.reward);
        } else {
          document.getElementById("lastWinner").textContent = "No game ended yet";
          document.getElementById("lastReward").textContent = "-";
        }

        document.getElementById("status").textContent = "‚úÖ Game data loaded.";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "‚ùå Failed to load game info.";
      }
    }

    async function joinGame() {
      if (!signer) {
        alert("Please connect your wallet first.");
        return;
      }

      const amount = document.getElementById("amount").value;
      const joinBtn = document.getElementById("joinBtn");
      joinBtn.disabled = true;
      document.getElementById("status").textContent = "üì§ Sending transaction...";

      try {
        const tx = await contract.play({ value: ethers.parseEther(amount) });
        await tx.wait();
        document.getElementById("status").textContent = "‚úÖ Successfully joined!";
        await loadGameInfo();
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "‚ùå Transaction failed.";
      }

      joinBtn.disabled = false;
    }

    window.addEventListener("load", async () => {
      await loadGameInfo();

      if (window.ethereum) {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          await connectWallet();
        }
      }
    });
  </script>
</body>

</html>